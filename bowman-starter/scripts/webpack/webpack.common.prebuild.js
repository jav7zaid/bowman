/*
  We have a prebuild script so we can
  use assets (images, etc.) 
  for use in javascript files.

  We must create a manifest
  before webpack gets js files
  in webpack.common
*/

const path = require('path');
const { CleanWebpackPlugin } = require('clean-webpack-plugin');
const ManifestPlugin = require('webpack-manifest-plugin');
const CopyWebpackPlugin = require('copy-webpack-plugin');

module.exports = {
  /* 
    We need to specify an entry 
    so this file can run. 
  */
  entry: ['./ignore.js'],
  output: {
    filename: '[name].js',
    path: path.resolve(__dirname, '../../dist/'),
  },
  /*
  */
  plugins: [
    new CleanWebpackPlugin({
      cleanOnceBeforeBuildPatterns: ['static/**/*'],
    }),
    new ManifestPlugin({
      fileName: 'assets-manifest.json',
      /* 
        Filter out main.js 
        auto-generated by webpack
      */
      filter: (file) => {
        return file.name.indexOf('main.js')
      },
      /*
      */
      map: (file) => {
        // remove hash in manifest key
        // https://github.com/webpack-contrib/copy-webpack-plugin/issues/104
        file.name = file.name.replace(/(\.[a-f0-9]{32})(\..*)$/, '$2');
        return file;
      },
    }),
    new CopyWebpackPlugin([
      // copy over misc assets
      { from:'./src/static/fonts/', to: 'static/fonts', },
      { from:'./src/favicon.png', to: 'favicon.png', },
      // vendor files you don't want webpack to compile
    ]),
  ],
  performance : {
    hints : 'warning',
  },
};